-- Build Escape from Brainrot Script FIXED by Grok
-- Fixes: ESP crash (obj -> part), Traces visible (per-player line), WalkSpeed flag, WorldToScreen, Menu reliable
-- Features: Block ESP (green box + name/dist), Player Traces (magenta movement line), WalkSpeed Slider, Rayfield UI

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local player = Players.LocalPlayer

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "Build Escape from Brainrot",
    LoadingTitle = "Injecting...",
    LoadingSubtitle = "by Grok (Fixed)",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "BrainrotBuild",
        FileName = "Config"
    },
    KeySystem = false
})

-- Notify on load
Rayfield:Notify({
    Title = "Script Loaded!",
    Content = "Menu ready. Toggle ESP/Traces, adjust WalkSpeed.",
    Duration = 4,
    Image = 4483362458
})

local PlayerTab = Window:CreateTab("Player", 4483362458)
local VisualsTab = Window:CreateTab("Visuals", 4483362458)

-- Variables
local ESPEnabled = false
local TraceEnabled = false
local ESPObjects = {}
local PlayerTraceLines = {}
local OldPositions = {}
local Humanoid = nil

-- ESP Functions
local function WorldToScreen(pos)
    local screenPoint, onScreen, depth = Camera:WorldToViewportPoint(pos)
    return Vector2.new(screenPoint.X, screenPoint.Y), onScreen, depth
end

local function CreateESP(part)
    local data = {}
    data.Box = Drawing.new("Square")
    data.Box.Filled = false
    data.Box.Thickness = 2
    data.Box.Transparency = 1
    data.Box.Color = Color3.fromRGB(0, 255, 0)
    data.Box.Visible = false

    data.Text = Drawing.new("Text")
    data.Text.Size = 16
    data.Text.Center = true
    data.Text.Outline = true
    data.Text.Font = 2
    data.Text.Color = Color3.fromRGB(255, 255, 255)
    data.Text.Visible = false

    ESPObjects[part] = data
end

local function AddBlockESP()
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Parent ~= player.Character and not obj.Parent:FindFirstChildOfClass("Humanoid") then
            local nameLower = obj.Name:lower()
            if (nameLower:find("block") or nameLower:find("brick") or nameLower:find("build") or nameLower:find("part")) and 
               obj.Size.Magnitude <= 20 and obj.Transparency == 0 and obj.CanCollide then
                if not ESPObjects[obj] then
                    CreateESP(obj)
                end
            end
        end
    end
end

local function UpdateESP()
    for part, data in pairs(ESPObjects) do
        if part and part.Parent then
            local pos = part.Position
            local centerPos, centerOnScreen = WorldToScreen(pos)
            if not centerOnScreen then
                data.Box.Visible = false
                data.Text.Visible = false
                continue
            end

            local topOffset = Vector3.new(0, part.Size.Y / 2, 0)
            local botOffset = Vector3.new(0, -part.Size.Y / 2, 0)
            local topPos, topOnScreen = WorldToScreen(pos + topOffset)
            local botPos, botOnScreen = WorldToScreen(pos + botOffset)

            if not (topOnScreen and botOnScreen) then
                data.Box.Visible = false
                data.Text.Visible = false
                continue
            end

            local height = math.abs(topPos.Y - botPos.Y)
            local width = height * 0.6
            data.Box.Size = Vector2.new(width, height)
            data.Box.Position = Vector2.new(centerPos.X - width / 2, topPos.Y)
            data.Box.Visible = true

            local dist = math.floor((Camera.CFrame.Position - pos).Magnitude)
            data.Text.Text = part.Name .. "\n[" .. dist .. "]"
            data.Text.Position = Vector2.new(centerPos.X, topPos.Y - 20)
            data.Text.Visible = true
        else
            if data.Box then data.Box:Remove() end
            if data.Text then data.Text:Remove() end
            ESPObjects[part] = nil
        end
    end
end

-- Traces Functions
local function UpdateTraces()
    if not TraceEnabled then return end

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character.HumanoidRootPart
            local uid = plr.UserId
            local oldPos = OldPositions[uid] or hrp.Position
            OldPositions[uid] = hrp.Position

            local startScreen, startOnScreen = WorldToScreen(oldPos)
            local endScreen, endOnScreen = WorldToScreen(hrp.Position)

            if startOnScreen and endOnScreen then
                local line = PlayerTraceLines[uid]
                if not line then
                    line = Drawing.new("Line")
                    line.Thickness = 3
                    line.Transparency = 0.7
                    PlayerTraceLines[uid] = line
                end
                line.From = startScreen
                line.To = endScreen
                line.Color = Color3.fromRGB(255, 0, 255)
                line.Visible = true
            else
                if PlayerTraceLines[uid] then
                    PlayerTraceLines[uid].Visible = false
                end
            end
        end
    end

    -- Cleanup disconnected
    for uid, line in pairs(PlayerTraceLines) do
        local plr = Players:GetPlayerByUserId(uid)
        if not plr then
            line:Remove()
            PlayerTraceLines[uid] = nil
            OldPositions[uid] = nil
        end
    end
end

-- Character Handling
local function OnCharacterAdded(char)
    local hum = char:WaitForChild("Humanoid", 5)
    if hum then
        Humanoid = hum
        hum.WalkSpeed = Rayfield.Flags.WalkSpeedSlider or 16
    end
end

player.CharacterAdded:Connect(OnCharacterAdded)
if player.Character then
    OnCharacterAdded(player.Character)
end

-- UI Elements
local WalkSpeedSlider = PlayerTab:CreateSlider({
    Name = "WalkSpeed",
    Range = {16, 300},
    Increment = 1,
    CurrentValue = 16,
    Suffix = " studs/s",
    Flag = "WalkSpeedSlider",
    Callback = function(Value)
        if Humanoid then
            Humanoid.WalkSpeed = Value
        end
    end
})

VisualsTab:CreateToggle({
    Name = "Block ESP (Build Blocks)",
    CurrentValue = false,
    Callback = function(Value)
        ESPEnabled = Value
        if Value then
            AddBlockESP()  -- Initial scan
            spawn(function()
                while ESPEnabled do
                    AddBlockESP()
                    wait(1.5)  -- Faster scan for new blocks
                end
            end)
        else
            for _, data in pairs(ESPObjects) do
                if data.Box then data.Box:Remove() end
                if data.Text then data.Text:Remove() end
            end
            ESPObjects = {}
        end
    end
})

VisualsTab:CreateToggle({
    Name = "Player Traces (Movement Lines)",
    CurrentValue = false,
    Callback = function(Value)
        TraceEnabled = Value
        if not Value then
            for _, line in pairs(PlayerTraceLines) do
                line:Remove()
            end
            PlayerTraceLines = {}
            OldPositions = {}
        end
    end
})

-- Main Loop
local Connection = RunService.Heartbeat:Connect(function()
    if ESPEnabled then
        UpdateESP()
    end
    UpdateTraces()
end)

Rayfield:LoadConfiguration()
