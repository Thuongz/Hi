local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "MM2 Farm Coins & EXP âœ… TELE FIXED 100%",
   LoadingTitle = "Loading Rayfield...",
   LoadingSubtitle = "CoinContainer Detect + TrÃ¡nh Sheriff & Murder 100m",
   ConfigurationSaving = { Enabled = true, FolderName = "MM2Farm", FileName = "Config" },
   KeySystem = false
})

local Tab = Window:CreateTab("Farm", 4483362458)

getgenv().AutoFarmCoins = false
getgenv().AutoFarmEXP = false
getgenv().AntiAFKEnabled = true

local TotalCoins = 0
local TotalRounds = 0
local CoinsInCurrentRound = 0

local CoinLabel = Tab:CreateLabel("Coins Farmed (Total): 0")
local RoundCoinLabel = Tab:CreateLabel("Coins in Round: 0 / 40")
local EXPLabel = Tab:CreateLabel("Rounds Completed: 0")

Tab:CreateToggle({
   Name = "ðŸš€ Auto Farm Coins (TrÃ¡nh Sheriff & Murder 100m - 2.0s/coin - CHá»ˆ TRONG VÃN)",
   CurrentValue = false,
   Callback = function(v) getgenv().AutoFarmCoins = v end
})

Tab:CreateToggle({
   Name = "âš¡ Auto Farm EXP (Tele nÃ³c Innocent/Sheriff + Kill Murderer sau 40 coins)",
   CurrentValue = false,
   Callback = function(v) getgenv().AutoFarmEXP = v end
})

Tab:CreateToggle({
   Name = "ðŸ›¡ï¸ Anti AFK (Tá»± Ä‘á»™ng báº­t)",
   CurrentValue = true,
   Callback = function(v) getgenv().AntiAFKEnabled = v end
})

local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer

task.spawn(function()
   while task.wait(60) do
      if getgenv().AntiAFKEnabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
         VirtualUser:CaptureController()
         VirtualUser:ClickButton2(Vector2.new())
      end
   end
end)

player.Idled:Connect(function()
   if getgenv().AntiAFKEnabled then
      VirtualUser:CaptureController()
      VirtualUser:ClickButton2(Vector2.new())
   end
end)

local function getHRP()
   return player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

local function getPlayerRole(plr)
   if plr:FindFirstChild("Role") and plr.Role:IsA("StringValue") then
      return plr.Role.Value
   end
   local char = plr.Character
   local backpack = plr.Backpack
   if (char and char:FindFirstChild("Knife")) or (backpack and backpack:FindFirstChild("Knife")) then return "Murderer" end
   if (char and char:FindFirstChild("Gun")) or (backpack and backpack:FindFirstChild("Gun")) then return "Sheriff" end
   return "Innocent"
end

local function getCoinContainer()
   return Workspace:FindFirstChild("CoinContainer", true)
end

local function isInRound()
   return getCoinContainer() ~= nil
end

local function isAlive()
   return player.Character and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0
end

local function getCoins()
   local coinContainer = getCoinContainer()
   if not coinContainer then return {} end
   local coins = {}
   for _, obj in pairs(coinContainer:GetChildren()) do
      if obj.Name == "Coin_Server" and obj:IsA("BasePart") then
         table.insert(coins, obj)
      end
   end
   return coins
end

local function getDangerousPlayers()
   local dangerous = {}
   for _, p in Players:GetPlayers() do
      if p ~= player then
         local role = getPlayerRole(p)
         if (role == "Murderer" or role == "Sheriff") and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            table.insert(dangerous, p.Character.HumanoidRootPart)
         end
      end
   end
   return dangerous
end

task.spawn(function()
   local wasInRound = false
   while task.wait(2) do
      local nowInRound = isInRound()
      if wasInRound and not nowInRound then
         CoinsInCurrentRound = 0
         RoundCoinLabel:Set("Coins in Round: 0 / 40")
      end
      wasInRound = nowInRound
   end
end)

-- Auto Farm Coins: 2.0s/coin - Dá»ªNG khi >=40
task.spawn(function()
   local recentlyTeleported = {}

   while task.wait(0.1) do
      if not getgenv().AutoFarmCoins or not isInRound() or not isAlive() then 
         continue 
      end
      
      if CoinsInCurrentRound >= 40 then
         task.wait(1)
         continue
      end
      
      local hrp = getHRP()
      if not hrp then continue end

      local coins = getCoins()
      if #coins == 0 then continue end

      local dangerous = getDangerousPlayers()

      local validCoins = {}
      for _, coin in pairs(coins) do
         local tooRecent = false
         for i = #recentlyTeleported, 1, -1 do
            local entry = recentlyTeleported[i]
            if (coin.Position - entry.pos).Magnitude < 10 then
               tooRecent = true
               break
            end
            if tick() - entry.time > 3 then
               table.remove(recentlyTeleported, i)
            end
         end
         if not tooRecent then
            table.insert(validCoins, coin)
         end
      end

      if #validCoins == 0 then continue end

      table.sort(validCoins, function(a, b)
         local distA = (hrp.Position - a.Position).Magnitude
         local distB = (hrp.Position - b.Position).Magnitude
         
         local safeA = math.huge
         local safeB = math.huge
         for _, d in pairs(dangerous) do
            safeA = math.min(safeA, (a.Position - d.Position).Magnitude)
            safeB = math.min(safeB, (b.Position - d.Position).Magnitude)
         end
         
         if safeA >= 100 and safeB < 100 then return true end
         if safeB >= 100 and safeA < 100 then return false end
         return distA < distB
      end)

      local coin = validCoins[1]
      if not coin or not coin.Parent then continue end

      local minDistToDanger = math.huge
      for _, d in pairs(dangerous) do
         minDistToDanger = math.min(minDistToDanger, (coin.Position - d.Position).Magnitude)
      end

      if minDistToDanger >= 100 then
         hrp.Velocity = Vector3.new(0,0,0)
         hrp.CFrame = CFrame.new(coin.Position)
         
         table.insert(recentlyTeleported, { pos = coin.Position, time = tick() })
         
         task.wait(0.3)
         
         local wasAlive = coin.Parent
         task.wait(1.7)
         
         if wasAlive and not coin.Parent then
            TotalCoins += 1
            CoinsInCurrentRound += 1
            CoinLabel:Set("Coins Farmed (Total): " .. TotalCoins)
            RoundCoinLabel:Set("Coins in Round: " .. CoinsInCurrentRound .. " / 40")
         end
      else
         task.wait(0.4)
      end
   end
end)

-- FIXED: Má»˜T LOOP THá»NG NHáº¤T - Tele nÃ³c (Innocent/Sheriff) HOáº¶C Kill All (Murderer) khi >=40 coins
task.spawn(function()
   while task.wait(0.5) do
      if not getgenv().AutoFarmEXP or not isInRound() or not isAlive() then continue end
      
      if CoinsInCurrentRound >= 40 then
         local myRole = getPlayerRole(player)
         local hrp = getHRP()
         if not hrp then continue end

         if myRole == "Murderer" then
            -- KILL ALL
            local knife = player.Character:FindFirstChild("Knife") or player.Backpack:FindFirstChild("Knife")
            if knife and knife:FindFirstChild("Handle") then
               if knife.Parent == player.Backpack then
                  knife.Parent = player.Character
               end
               
               local killedAnyone = false
               for _, p in Players:GetPlayers() do
                  if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
                     local target = p.Character.HumanoidRootPart
                     hrp.CFrame = target.CFrame * CFrame.new(0, 0, -2.5)
                     task.wait(0.05)
                     local handle = knife.Handle
                     firetouchinterest(handle, target, 0)
                     task.wait(0.05)
                     firetouchinterest(handle, target, 1)
                     killedAnyone = true
                  end
               end
               
               if killedAnyone then
                  TotalRounds += 1
                  EXPLabel:Set("Rounds Completed: " .. TotalRounds)
               end
            end
         else
            -- TELE LÃŠN NÃ“C (Innocent hoáº·c Sheriff)
            hrp.CFrame = CFrame.new(0, 500, 0)
         end
         
         -- RESET NGAY sau hÃ nh Ä‘á»™ng Ä‘á»ƒ UI update vÃ  trÃ¡nh loop
         CoinsInCurrentRound = 0
         RoundCoinLabel:Set("Coins in Round: 0 / 40")
      end
   end
end)
