local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "MM2 Farm Coins & EXP ‚úÖ TELE FIXED 100%",
   LoadingTitle = "Loading Rayfield...",
   LoadingSubtitle = "CoinContainer Detect + Tr√°nh Murder 90m",
   ConfigurationSaving = { Enabled = true, FolderName = "MM2Farm", FileName = "Config" },
   KeySystem = false
})

local Tab = Window:CreateTab("Farm", 4483362458)

getgenv().AutoFarmCoins = false
getgenv().AutoFarmEXP = false
getgenv().AntiAFKEnabled = true

local TotalCoins = 0
local TotalRounds = 0
local CoinsInCurrentRound = 0

local CoinLabel = Tab:CreateLabel("Coins Farmed (Total): 0")
local RoundCoinLabel = Tab:CreateLabel("Coins in Round: 0 / 40")
local EXPLabel = Tab:CreateLabel("Rounds Completed: 0")

Tab:CreateToggle({
   Name = "üöÄ Auto Farm Coins (Tr√°nh Murder 90m - 1.9s/coin - CoinContainer)",
   CurrentValue = false,
   Callback = function(v) getgenv().AutoFarmCoins = v end
})

Tab:CreateToggle({
   Name = "‚ö° Auto Farm EXP (Kill All sau 40 coins)",
   CurrentValue = false,
   Callback = function(v) getgenv().AutoFarmEXP = v end
})

Tab:CreateToggle({
   Name = "üõ°Ô∏è Anti AFK (T·ª± ƒë·ªông b·∫≠t)",
   CurrentValue = true,
   Callback = function(v) getgenv().AntiAFKEnabled = v end
})

local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer

task.spawn(function()
   while task.wait(60) do
      if getgenv().AntiAFKEnabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
         VirtualUser:CaptureController()
         VirtualUser:ClickButton2(Vector2.new())
      end
   end
end)

player.Idled:Connect(function()
   if getgenv().AntiAFKEnabled then
      VirtualUser:CaptureController()
      VirtualUser:ClickButton2(Vector2.new())
   end
end)

local function getHRP()
   return player.Character and player.Character:FindFirstChild("HumanoidRootPart")
end

local function getPlayerRole(plr)
   if plr:FindFirstChild("Role") and plr.Role:IsA("StringValue") then
      return plr.Role.Value
   end
   local char = plr.Character
   local backpack = plr.Backpack
   if (char and char:FindFirstChild("Knife")) or (backpack and backpack:FindFirstChild("Knife")) then return "Murderer" end
   if (char and char:FindFirstChild("Gun")) or (backpack and backpack:FindFirstChild("Gun")) then return "Sheriff" end
   return "Innocent"
end

local function getCoinContainer()
   return Workspace:FindFirstChild("CoinContainer", true)
end

local function isInRound()
   return getCoinContainer() ~= nil
end

local function getCoins()
   local coinContainer = getCoinContainer()
   if not coinContainer then return {} end
   local coins = {}
   for _, obj in pairs(coinContainer:GetChildren()) do
      if obj.Name == "Coin_Server" and obj:IsA("BasePart") then
         table.insert(coins, obj)
      end
   end
   return coins
end

local function getMurderers()
   local murders = {}
   for _, p in Players:GetPlayers() do
      if p ~= player and getPlayerRole(p) == "Murderer" and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
         table.insert(murders, p.Character.HumanoidRootPart)
      end
   end
   return murders
end

task.spawn(function()
   local wasInRound = false
   while task.wait(2) do
      local nowInRound = isInRound()
      if wasInRound and not nowInRound then
         CoinsInCurrentRound = 0
         RoundCoinLabel:Set("Coins in Round: 0 / 40")
      end
      wasInRound = nowInRound
   end
end)

-- ƒê√É CH·ªàNH: T·ªëc ƒë·ªô 1.9s/coin + Tr√°nh Murder ‚â• 90 studs
task.spawn(function()
   local recentlyTeleported = {}  -- Cache v·ªã tr√≠ coin ƒë√£ tele g·∫ßn ƒë√¢y

   while task.wait(0.1) do
      if not getgenv().AutoFarmCoins or not isInRound() then 
         continue 
      end
      
      local hrp = getHRP()
      if not hrp or not player.Character or player.Character.Humanoid.Health <= 0 then 
         continue 
      end

      local coins = getCoins()
      if #coins == 0 then 
         continue 
      end

      local murders = getMurderers()

      -- L·ªçc b·ªè coin c≈© ƒë√£ tele g·∫ßn ƒë√¢y
      local validCoins = {}
      for _, coin in pairs(coins) do
         local tooRecent = false
         for i = #recentlyTeleported, 1, -1 do
            local entry = recentlyTeleported[i]
            if (coin.Position - entry.pos).Magnitude < 10 then
               tooRecent = true
               break
            end
            if tick() - entry.time > 3 then
               table.remove(recentlyTeleported, i)
            end
         end
         if not tooRecent then
            table.insert(validCoins, coin)
         end
      end

      if #validCoins == 0 then
         continue
      end

      -- Sort ∆∞u ti√™n an to√†n tr∆∞·ªõc, sau ƒë√≥ g·∫ßn nh·∫•t
      table.sort(validCoins, function(a, b)
         local distA = (hrp.Position - a.Position).Magnitude
         local distB = (hrp.Position - b.Position).Magnitude
         
         local safeA = math.huge
         local safeB = math.huge
         for _, m in pairs(murders) do
            safeA = math.min(safeA, (a.Position - m.Position).Magnitude)
            safeB = math.min(safeB, (b.Position - m.Position).Magnitude)
         end
         
         if safeA >= 90 and safeB < 90 then return true end
         if safeB >= 90 and safeA < 90 then return false end
         return distA < distB
      end)

      local coin = validCoins[1]
      if not coin or not coin.Parent then 
         continue 
      end

      local minDistToMurder = math.huge
      for _, m in pairs(murders) do
         minDistToMurder = math.min(minDistToMurder, (coin.Position - m.Position).Magnitude)
      end

      -- Ch·ªâ tele n·∫øu coin c√°ch Murderer ‚â• 90 studs
      if minDistToMurder >= 90 then
         hrp.Velocity = Vector3.new(0,0,0)
         hrp.CFrame = CFrame.new(coin.Position)
         
         table.insert(recentlyTeleported, { pos = coin.Position, time = tick() })
         
         task.wait(0.3)         -- TƒÉng nh·∫π delay ƒë·∫ßu ƒë·ªÉ ·ªïn ƒë·ªãnh h∆°n
         
         local wasAlive = coin.Parent
         task.wait(1.6)         -- T·ªïng delay sau tele: 0.3 + 1.6 = 1.9 gi√¢y/coin
         
         if wasAlive and not coin.Parent then
            TotalCoins += 1
            CoinsInCurrentRound += 1
            CoinLabel:Set("Coins Farmed (Total): " .. TotalCoins)
            RoundCoinLabel:Set("Coins in Round: " .. CoinsInCurrentRound .. " / 40")
         end
      else
         task.wait(0.4)
      end
   end
end)

task.spawn(function()
   while task.wait(1) do
      if CoinsInCurrentRound >= 40 and isInRound() then
         local myRole = getPlayerRole(player)
         if myRole == "Innocent" then
            local hrp = getHRP()
            if hrp then
               hrp.CFrame = CFrame.new(0, 350, 0)
            end
            CoinsInCurrentRound = 0
            RoundCoinLabel:Set("Coins in Round: 0 / 40")
         end
      end
   end
end)

task.spawn(function()
   while task.wait(1) do
      if getgenv().AutoFarmEXP and CoinsInCurrentRound >= 40 and player.Character and player.Character.Humanoid.Health > 0 then
         local knife = player.Character:FindFirstChild("Knife") or player.Backpack:FindFirstChild("Knife")
         if knife and knife:FindFirstChild("Handle") then
            if knife.Parent == player.Backpack then knife.Parent = player.Character end
            for _, p in Players:GetPlayers() do
               if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character.Humanoid.Health > 0 then
                  local target = p.Character.HumanoidRootPart
                  local hrp = getHRP()
                  if hrp then
                     hrp.CFrame = target.CFrame * CFrame.new(0, 0, -2.5)
                     task.wait(0.1)
                     local handle = knife.Handle
                     firetouchinterest(handle, target, 0)
                     task.wait(0.1)
                     firetouchinterest(handle, target, 1)
                  end
               end
            end
            TotalRounds += 1
            EXPLabel:Set("Rounds Completed: " .. TotalRounds)
            CoinsInCurrentRound = 0
            RoundCoinLabel:Set("Coins in Round: 0 / 40")
         end
      end
   end
end)
